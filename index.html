<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic English Simulator</title>
    <style>
        :root { 
            --primary: #51247a; 
            --secondary: #962a8b; 
            --bg: #f5f7fa; 
            --text: #2c3e50; 
            --success: #27ae60; 
            --error: #c0392b; 
            --warning: #f39c12;
            --selected-bg: #eaddff; 
            --selected-border: #51247a; 
            --highlight-color: #fff200; /* ÈõÖÊÄùÊ†áÂáÜËçßÂÖâÈªÑ */
        }
        
        body { font-family: 'Segoe UI', Inter, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 1000px; width: 100%; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: none; margin-bottom: 40px;}
        
        /* Ê®°ÂºèÈÄâÊã©Âç°Áâá */
        .mode-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 30px; }
        .mode-card { border: 2px solid #eee; padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left; }
        .mode-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .mode-card.selected { border-color: var(--primary); background-color: var(--selected-bg); }
        .mode-card h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; }
        .mode-card p { font-size: 0.9rem; color: #666; margin: 5px 0; }
        
        /* --- [NEW] È°∂ÈÉ®Áä∂ÊÄÅÊ†è & È´ò‰∫ÆÂºÄÂÖ≥ --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; position: sticky; top: 0; background: white; z-index: 100; padding-top: 10px;}
        .timer { font-size: 1.8rem; font-weight: 800; color: var(--error); font-variant-numeric: tabular-nums; }
        
        /* È´ò‰∫ÆÂºÄÂÖ≥Ê†∑Âºè */
        .tool-control { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: 600; color: #555; background: #f8f9fa; padding: 5px 15px; border-radius: 20px; border: 1px solid #ddd; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--secondary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- [NEW] È´ò‰∫ÆÊñáÊú¨Ê†∑Âºè --- */
        .highlight-text { background-color: var(--highlight-color); cursor: pointer; border-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .highlight-text:hover { background-color: #ffdb4d; /* HoverÊó∂ÂèòÊ∑±‰∏ÄÁÇπÊèêÁ§∫ÂèØÁÇπÂáª */ }
        /* ÂºÄÂêØÈ´ò‰∫ÆÊ®°ÂºèÊó∂ÁöÑÈº†Ê†áÊ†∑Âºè */
        body.pen-active .passage, 
        body.pen-active .option-card,
        body.pen-active .s4-text-area { cursor: text; } 

        /* Stage 1-3 ÈÄöÁî®Ê†∑Âºè */
        .passage { font-size: 1.1rem; line-height: 1.7; color: #2c3e50; background: #fffbf2; padding: 25px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 25px; text-align: justify; }
        .stage-badge { display: inline-block; padding: 5px 12px; border-radius: 4px; font-weight: bold; color: white; margin-bottom: 10px; font-size: 0.9rem; background: var(--secondary); }
        .option-card { padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; margin-bottom: 10px; transition: all 0.2s; display: flex; }
        .option-card:hover { background: #fafafa; border-color: #bbb; }
        .option-card.selected { background-color: var(--selected-bg); border-color: var(--selected-border); }
        .headings-box { background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 5px solid #2980b9; margin-bottom: 30px; }
        .headings-list li { margin-bottom: 8px; font-weight: 500; }
        .match-select { padding: 10px; font-size: 1rem; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; min-width: 120px; max-width: 100%;}
        .question-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; }
        .question-text { flex: 1; margin-right: 20px; font-weight: 500; color: #34495e; }

        /* Stage 4 */
        .s4-layout { display: flex; gap: 30px; align-items: flex-start; }
        .s4-text-area { flex: 2; font-size: 1.1rem; line-height: 1.8; text-align: justify; }
        .s4-options-area { flex: 1; position: sticky; top: 80px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd; max-height: 80vh; overflow-y: auto; }
        .gap-zone { display: block; margin: 20px 0; padding: 15px; background: #fff3e0; border: 2px dashed #f57c00; border-radius: 8px; text-align: center; color: #e65100; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .gap-zone.drag-over { background: #ffe0b2; transform: scale(1.02); }
        .gap-zone.filled { background: #e8f5e9; border: 2px solid #2e7d32; border-style: solid; color: #2e7d32; text-align: left; font-weight: normal; }
        .draggable-item { background: white; border: 1px solid #ccc; padding: 12px; margin-bottom: 10px; border-radius: 6px; cursor: grab; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; }
        .draggable-item:hover { border-color: var(--primary); }
        .draggable-item.active-select { background: var(--selected-bg); border: 2px solid var(--primary); }

        /* UI Elements */
        .action-btn { padding: 12px 30px; font-size: 1rem; border-radius: 8px; cursor: pointer; border: none; font-weight: 600; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
        .btn-outline { background: transparent; border: 2px solid #ccc; color: #666; }
        .btn-outline:hover { border-color: #999; color: #333; background: #f0f0f0; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Review */
        .review-card { border: 1px solid #eee; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: white; }
        .review-passage { background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 0.95rem; color: #555; margin-bottom: 15px; font-style: italic; border-left: 4px solid #ddd; line-height: 1.6; }
        .review-opt { padding: 10px; border: 1px solid #eee; margin-bottom: 6px; border-radius: 6px; display: flex; align-items: flex-start; }
        .rev-correct { background: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: 600; }
        .rev-wrong { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .rev-neutral { color: #777; }
        .tag-correct { color: var(--success); font-weight: bold; }
        .tag-wrong { color: var(--error); font-weight: bold; text-decoration: line-through; }
        
        @media (max-width: 800px) { 
            .s4-layout { flex-direction: column; } 
            .s4-options-area { width: 100%; position: relative; top: 0; order: -1; margin-bottom: 20px; max-height: 300px;}
            .mode-selection { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="setup" class="container" style="display: block; text-align: center; margin-top: 50px;">
        <h1 style="color: var(--primary); margin-bottom: 10px;">Reading Simulator</h1>
        <p style="color: #666;">Select your exam stage to begin</p>
        <div class="mode-selection">
            <div class="mode-card" id="card-stage1" onclick="selectMode('stage1')"><h3>Stage 1: MCQs</h3><p>8 Paragraphs ‚Ä¢ 4 Options</p><p><strong>Time:</strong> ~16 mins</p></div>
            <div class="mode-card" id="card-stage2" onclick="selectMode('stage2')"><h3>Stage 2: Matching</h3><p>7 Sections ‚Ä¢ 9 Headings</p><p><strong>Time:</strong> 8 mins</p></div>
            <div class="mode-card" id="card-stage3" onclick="selectMode('stage3')"><h3>Stage 3: Locating</h3><p>7 Sections ‚Ä¢ 7 Statements</p><p><strong>Time:</strong> 11 mins</p></div>
            <div class="mode-card" id="card-stage4" onclick="selectMode('stage4')"><h3>Stage 4: Gapped Text</h3><p>6 Gaps ‚Ä¢ 7 Paragraphs</p><p><strong>Time:</strong> 14 mins</p></div>
        </div>
        <div style="margin-top: 30px;">
            <input type="text" id="access-token" placeholder="Enter Access Code (Optional)" style="padding: 10px; width: 60%; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
            <br><br>
            <button class="action-btn btn-primary" onclick="initExam()" id="start-btn" disabled style="max-width: 300px;">Select a Mode First</button>
        </div>
        <div id="loading" style="display: none;"><div class="loader"></div><p>Connecting to Examiner ...<br><small>(Wait time: ~40-60s)</small></p></div>
    </div>

    <div id="exam-stage1" class="container">
        <div class="header">
            <div><strong>Stage 1</strong>: Q <span id="s1-q-num">1</span> / 8</div>
            <div class="tool-control">
                <span>üñäÔ∏è Highlight Mode</span>
                <label class="toggle-switch" style="margin-left: 8px;">
                    <input type="checkbox" id="hl-toggle-1" onchange="toggleHighlighter(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="timer-s1" class="timer">01:00</div>
        </div>
        <span id="s1-phase-badge" class="stage-badge">PHASE 1: READING</span>
        <div id="s1-passage" class="passage"></div>
        <h3 id="s1-question" style="color: var(--primary); border-left: 5px solid var(--secondary); padding-left: 15px;">Loading...</h3>
        <div id="s1-options" style="display: none;"></div>
        <div id="s1-controls" style="display: none; margin-top: 20px; justify-content: space-between; gap: 15px;">
            <button class="action-btn btn-outline" onclick="skipStage1()" style="width: 40%;">Skip / Unlock</button>
            <button id="s1-next-btn" class="action-btn btn-primary" onclick="submitStage1Question()" disabled style="width: 60%;">Next Question</button>
        </div>
    </div>

    <div id="exam-stage2" class="container">
        <div class="header">
            <div><strong>Stage 2</strong>: Matching Headings</div>
            <div class="tool-control">
                <span>üñäÔ∏è Highlight</span>
                <label class="toggle-switch" style="margin-left: 8px;">
                    <input type="checkbox" id="hl-toggle-2" onchange="toggleHighlighter(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="timer-s2" class="timer">01:00</div>
        </div>
        <div id="s2-phase1" style="display: block;">
            <div class="headings-box"><h3 style="margin-top:0;">List of Headings</h3><ul id="s2-headings-preview" class="headings-list"></ul></div>
            <p style="text-align: center; color: #666;">Memorize these headings. 1 Minute.</p>
        </div>
        <div id="s2-phase2" style="display: none;">
            <div class="headings-box" style="padding: 10px 20px;">
                <h4 style="margin:0; cursor: pointer;" onclick="toggleId('s2-headings-ref')">üëÅÔ∏è Toggle Headings List</h4>
                <ul id="s2-headings-ref" class="headings-list" style="display: none; margin-top: 10px;"></ul>
            </div>
            <h2 id="s2-title" style="text-align: center; color: var(--primary);"></h2>
            <div id="s2-passages-container"></div>
            <button class="action-btn btn-primary" onclick="finishStage2()" style="margin-top: 30px;">Submit All Matches</button>
        </div>
    </div>

    <div id="exam-stage3" class="container">
        <div class="header">
            <div><strong>Stage 3</strong>: Locating Info</div>
            <div class="tool-control">
                <span>üñäÔ∏è Highlight</span>
                <label class="toggle-switch" style="margin-left: 8px;">
                    <input type="checkbox" id="hl-toggle-3" onchange="toggleHighlighter(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="timer-s3" class="timer">01:00</div>
        </div>
        <div id="s3-phase1">
            <div class="headings-box" style="border-left-color: #e67e22; background: #fff5e6;">
                <h3 style="margin-top:0; color: #d35400;">Information to Locate:</h3>
                <ul id="s3-questions-preview" class="headings-list"></ul>
            </div>
            <p style="text-align: center; color: #666;">Read the statements carefully. 1 Minute.</p>
        </div>
        <div id="s3-phase2" style="display: none;">
            <h2 id="s3-title" style="text-align: center; color: var(--primary);"></h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #eee;">
                <h3 style="margin-top:0; margin-bottom: 15px;">Answer Sheet</h3>
                <div id="s3-questions-container"></div>
            </div>
            <div id="s3-passages-container"></div>
            <button class="action-btn btn-primary" onclick="finishStage3()" style="margin-top: 30px;">Submit Stage 3</button>
        </div>
    </div>

    <div id="exam-stage4" class="container" style="max-width: 1100px;">
        <div class="header">
            <div><strong>Stage 4</strong>: Gapped Text</div>
            <div class="tool-control">
                <span>üñäÔ∏è Highlight</span>
                <label class="toggle-switch" style="margin-left: 8px;">
                    <input type="checkbox" id="hl-toggle-4" onchange="toggleHighlighter(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="timer-s4" class="timer">14:00</div>
        </div>
        <p style="background: #e8f4f8; padding: 10px; border-radius:6px; color:#555; text-align:center;">
            <strong>Task:</strong> Drag paragraphs from the right (or Click to Select) and fill the gaps.
        </p>
        <h2 id="s4-title" style="text-align: center; color: var(--primary);"></h2>
        <div class="s4-layout">
            <div class="s4-text-area" id="s4-text-container"></div>
            <div class="s4-options-area">
                <h4 style="margin-top:0;">Paragraph Options (A-G)</h4>
                <div id="s4-pool-container"></div>
                <div style="margin-top:15px; text-align:center;">
                    <button class="action-btn btn-outline" onclick="resetStage4()" style="font-size:0.9rem; padding:8px;">Reset All</button>
                </div>
            </div>
        </div>
        <button class="action-btn btn-primary" onclick="finishStage4()" style="margin-top: 30px;">Submit Stage 4</button>
    </div>

    <div id="scoreboard" class="container">
        <div style="text-align: center; border-bottom: 2px solid #eee; padding-bottom: 20px;">
            <h1 style="color: var(--primary);">Exam Results</h1>
            <h2 style="font-size: 3rem; margin: 10px 0;">
                <span id="final-score" style="color: var(--success);">0</span> 
                <span style="font-size: 1.5rem; color: #999;">/ Total</span>
            </h2>
            <button class="action-btn btn-primary" onclick="location.reload()">Start New Exam</button>
        </div>
        <div id="review-content" style="margin-top: 30px;"></div>
    </div>

    <script>
        const isLocal = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost";
        const API_URL = isLocal ? "http://127.0.0.1:5000/generate-exam" : "https://uq-reading-exam-page01.onrender.com";
        
        let currentMode = null;
        let examData = null;
        let timerInterval = null;
        
        // Data Stores
        let s1Index = 0;
        let s1UserAnswers = [];
        let s1CurrentSelection = null;
        let s2UserAnswers = {}; 
        let s3UserAnswers = {}; 
        let s4UserAnswers = {}; 
        let s4SelectedId = null;

        // --- [NEW] Highlighter Logic ---
        let isHighlighterActive = false;

        function toggleHighlighter(active) {
            isHighlighterActive = active;
            // ÂêåÊ≠•ÊâÄÊúâ Toggle ÊåâÈíÆÁöÑÁä∂ÊÄÅ
            ['hl-toggle-1', 'hl-toggle-2', 'hl-toggle-3', 'hl-toggle-4'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.checked = active;
            });
            if(active) document.body.classList.add('pen-active');
            else document.body.classList.remove('pen-active');
        }

        // ÁõëÂê¨Èº†Ê†áÊä¨Ëµ∑‰∫ã‰ª∂Êù•Ëß¶ÂèëÈ´ò‰∫Æ
        document.addEventListener('mouseup', function() {
            if (!isHighlighterActive) return;

            const selection = window.getSelection();
            if (selection.toString().length === 0) return;

            // Ëé∑ÂèñÈÄâÂå∫Âπ∂È´ò‰∫Æ
            // Ê≥®ÊÑèÔºöË∑®Ë∂äÂ§ö‰∏™Â§çÊùÇÁöÑHTMLÊ†áÁ≠æ(Â¶ÇË∑®ÊÆµËêΩ)ÂèØËÉΩ‰ºöÂØºËá¥ surroundContents Êä•Èîô
            // ËøôÈáåÊàë‰ª¨ÂÅö‰∏Ä‰∏™ÁÆÄÂçïÁöÑÈîôËØØÊçïÊçâ
            try {
                const range = selection.getRangeAt(0);
                
                // ÈôêÂà∂ÔºöÂè™ËÉΩÂú®È´ò‰∫Æ ÊñáÁ´†(passage) Êàñ ÈÄâÈ°π(options) Âå∫Âüü
                const commonAncestor = range.commonAncestorContainer;
                const parent = commonAncestor.nodeType === 1 ? commonAncestor : commonAncestor.parentNode;
                
                // Ê£ÄÊü•ÊòØÂê¶Âú®ÂÖÅËÆ∏ÁöÑÂÆπÂô®ÂÜÖ
                if (parent.closest('.passage') || parent.closest('.option-card') || parent.closest('.s4-text-area') || parent.closest('.question-text') || parent.closest('.draggable-item')) {
                    const span = document.createElement('span');
                    span.className = 'highlight-text';
                    span.title = 'Click to remove highlight';
                    // ÁÇπÂáªÈ´ò‰∫ÆÂå∫ÂüüÂèñÊ∂àÈ´ò‰∫Æ
                    span.onclick = function(e) {
                        e.stopPropagation(); // Èò≤Ê≠¢Ëß¶ÂèëÈÄâÈ°πÁÇπÂáª
                        if(isHighlighterActive) {
                            const text = document.createTextNode(this.innerText);
                            this.parentNode.replaceChild(text, this);
                        }
                    };
                    
                    range.surroundContents(span);
                    selection.removeAllRanges(); // È´ò‰∫ÆÂêéÂèñÊ∂àÈÄâÂå∫ËßÜËßâÁä∂ÊÄÅ
                }
            } catch (e) {
                console.log("Unable to highlight simple range (likely crosses block elements)", e);
            }
        });

        // --- ËæÖÂä©ÂáΩÊï∞ ---
        function toggleId(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // --- 1. Ê®°ÂºèÈÄâÊã© ---
        function selectMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('selected'));
            document.getElementById('card-' + mode).classList.add('selected');
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.innerText = `Start ${mode.toUpperCase()} Exam`;
        }

        // --- 2. ÂàùÂßãÂåñËÄÉËØï ---
        async function initExam() {
            if (!currentMode) return;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            const token = document.getElementById('access-token').value.trim() || "guest";

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, stage: currentMode })
                });

                if (!response.ok) throw new Error("Server Error: " + response.status);
                const data = await response.json();
                
                document.getElementById('setup').style.display = 'none';
                
                // ÈáçÁΩÆÈ´ò‰∫ÆÂºÄÂÖ≥
                toggleHighlighter(false);

                if (currentMode === 'stage1') { examData = data.exam_set; startStage1(); }
                else if (currentMode === 'stage2') { examData = data; startStage2(); }
                else if (currentMode === 'stage3') { examData = data; startStage3(); }
                else if (currentMode === 'stage4') { examData = data; startStage4(); }

            } catch (err) {
                console.error(err);
                alert("Failed to load exam.\nError: " + err.message);
                location.reload();
            }
        }

        function startTimer(seconds, displayElem, onComplete) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            function update() {
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                displayElem.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                displayElem.style.color = timeLeft <= 30 ? 'red' : 'var(--error)';
            }
            update();
            timerInterval = setInterval(() => {
                timeLeft--;
                update();
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    onComplete();
                }
            }, 1000);
        }

        // ================= STAGE 1 =================
        function startStage1() {
            document.getElementById('exam-stage1').style.display = 'block';
            s1Index = 0; s1UserAnswers = []; loadStage1Question();
        }
        function loadStage1Question() {
            const q = examData[s1Index];
            s1CurrentSelection = null;
            document.getElementById('s1-q-num').innerText = s1Index + 1;
            document.getElementById('s1-passage').innerText = q.passage;
            document.getElementById('s1-question').innerText = q.question;
            document.getElementById('s1-question').style.display = 'block'; 
            document.getElementById('s1-options').style.display = 'none';
            document.getElementById('s1-controls').style.display = 'flex';
            document.getElementById('s1-next-btn').disabled = true;
            document.getElementById('s1-phase-badge').innerText = "PHASE 1: READ (60s)";
            document.getElementById('s1-phase-badge').style.background = "#e67e22";

            startTimer(60, document.getElementById('timer-s1'), () => {
                document.getElementById('s1-phase-badge').innerText = "PHASE 2: ANSWER (60s)";
                document.getElementById('s1-phase-badge').style.background = "#27ae60";
                document.getElementById('s1-options').innerHTML = q.options.map((o,i)=>
                    `<div class="option-card" id="opt-${i}" onclick="selectS1Option(${i})"><strong style="margin-right:10px;">${String.fromCharCode(65+i)}.</strong> ${o}</div>`
                ).join('');
                document.getElementById('s1-options').style.display = 'block';
                startTimer(60, document.getElementById('timer-s1'), submitStage1Question);
            });
        }
        function selectS1Option(i) {
            // Â¶ÇÊûúÈ´ò‰∫ÆÊ®°ÂºèÂºÄÂêØÔºåÁÇπÂáªÈÄâÈ°πÂèØËÉΩÊòØ‰∏∫‰∫ÜÂèñÊ∂àÈ´ò‰∫ÆÔºå‰∏çË¶ÅËß¶ÂèëÈÄâÊã©
            // ‰ΩÜÂõ†‰∏∫È´ò‰∫ÆÁÇπÂáªÂú® capture Èò∂ÊÆµÂ§ÑÁêÜ‰∫ÜÔºåËøôÈáå‰∏ªË¶ÅÂ§ÑÁêÜÂç°ÁâáÁÇπÂáª
            if(window.getSelection().toString().length > 0) return; // Ê≠£Âú®ÈÄâÊñáÂ≠ó

            s1CurrentSelection = i;
            document.querySelectorAll('.option-card').forEach(e=>e.classList.remove('selected'));
            document.getElementById('opt-'+i).classList.add('selected');
            document.getElementById('s1-next-btn').disabled = false;
        }
        function skipStage1() { s1CurrentSelection = -1; submitStage1Question(); }
        function submitStage1Question() {
            clearInterval(timerInterval);
            s1UserAnswers.push(s1CurrentSelection === null ? -1 : s1CurrentSelection);
            if(s1Index < 7) { s1Index++; loadStage1Question(); } else { showResultsStage1(); }
        }

        // ================= STAGE 2 =================
        function startStage2() {
            document.getElementById('exam-stage2').style.display = 'block';
            document.getElementById('s2-headings-preview').innerHTML = Object.keys(examData.headings).map(k=>`<li><span style="color:var(--primary);">${k}.</span> ${examData.headings[k]}</li>`).join('');
            document.getElementById('s2-headings-ref').innerHTML = document.getElementById('s2-headings-preview').innerHTML;
            startTimer(60, document.getElementById('timer-s2'), () => enterStage2Phase2());
        }
        function enterStage2Phase2() {
            document.getElementById('s2-phase1').style.display = 'none';
            document.getElementById('s2-phase2').style.display = 'block';
            document.getElementById('s2-title').innerText = examData.title;
            let opts = '<option value="" disabled selected>Select Heading...</option>' + 
                Object.keys(examData.headings).map(k => {
                    const fullText = examData.headings[k];
                    const shortText = fullText.length > 40 ? fullText.substring(0, 40) + "..." : fullText;
                    return `<option value="${k}">${k} - ${shortText}</option>`;
                }).join('');
            document.getElementById('s2-passages-container').innerHTML = examData.sections.map(s=>`
                <div class="passage" style="position:relative;">
                    <div style="position:absolute; top:-10px; left:-10px; background:var(--primary); color:white; padding:5px 10px; font-weight:bold; border-radius:4px;">Section ${s.id}</div>
                    <p style="margin-top:15px;">${s.text}</p>
                    <div style="background:#eee; padding:10px; border-radius:6px; margin-top:10px;">
                        <strong>Match Heading:</strong> <select class="match-select" onchange="s2UserAnswers['${s.id}']=this.value">${opts}</select>
                    </div>
                </div>`).join('');
            setTimeout(() => { alert("Start Matching! 7 minutes."); startTimer(420, document.getElementById('timer-s2'), finishStage2); }, 100);
        }
        function finishStage2() { clearInterval(timerInterval); showResultsStage2(); }

        // ================= STAGE 3 =================
        function startStage3() {
            document.getElementById('exam-stage3').style.display = 'block';
            document.getElementById('s3-questions-preview').innerHTML = examData.questions.map(q => `<li><b>${q.id}.</b> ${q.text}</li>`).join('');
            startTimer(60, document.getElementById('timer-s3'), () => enterStage3Phase2());
        }
        function enterStage3Phase2() {
            document.getElementById('s3-phase1').style.display = 'none';
            document.getElementById('s3-phase2').style.display = 'block';
            document.getElementById('s3-title').innerText = examData.title;
            let opts = '<option value="" disabled selected>Sec?</option>' + ['A','B','C','D','E','F','G'].map(k=>`<option value="${k}">Section ${k}</option>`).join('');
            document.getElementById('s3-questions-container').innerHTML = examData.questions.map(q => `
                <div class="question-row"><div class="question-text"><b>${q.id}.</b> ${q.text}</div><select class="match-select" onchange="s3UserAnswers['${q.id}']=this.value">${opts}</select></div>`).join('');
            document.getElementById('s3-passages-container').innerHTML = examData.sections.map(s => `
                <div class="passage" style="position:relative;"><div style="position:absolute; top:-10px; left:-10px; background:var(--primary); color:white; padding:5px 10px; font-weight:bold; border-radius:4px;">Section ${s.id}</div><p style="margin-top:15px;">${s.text}</p></div>`).join('');
            setTimeout(() => { alert("Start Locating! 10 minutes."); startTimer(600, document.getElementById('timer-s3'), finishStage3); }, 100);
        }
        function finishStage3() { clearInterval(timerInterval); showResultsStage3(); }

        // ================= STAGE 4 =================
        function startStage4() {
            document.getElementById('exam-stage4').style.display = 'block';
            document.getElementById('s4-title').innerText = examData.title;
            let processedText = examData.base_text.replace(/\[\[(\d+)\]\]/g, (match, num) => {
                return `<div class="gap-zone" id="gap-${num}" data-num="${num}" ondrop="dropS4(event)" ondragover="allowDropS4(event)" onclick="handleClickGapS4('${num}')">[ GAP ${num} ] <br><small style="font-weight:normal">(Drop Here or Click)</small></div>`;
            });
            processedText = processedText.replace(/\n/g, '<br>'); 
            document.getElementById('s4-text-container').innerHTML = processedText;
            renderStage4Pool();
            startTimer(840, document.getElementById('timer-s4'), finishStage4);
        }
        function renderStage4Pool() {
            const container = document.getElementById('s4-pool-container');
            container.innerHTML = '';
            examData.options.forEach(opt => {
                const isUsed = Object.values(s4UserAnswers).includes(opt.id);
                if (!isUsed) {
                    const div = document.createElement('div');
                    div.className = 'draggable-item';
                    div.id = `opt-${opt.id}`;
                    div.draggable = true;
                    div.innerHTML = `<strong>Paragraph ${opt.id}</strong><p style="margin:5px 0 0; font-size:0.9rem; color:#444;">${opt.text}</p>`;
                    div.ondragstart = (e) => { e.dataTransfer.setData("text", opt.id); };
                    div.onclick = () => {
                        if(window.getSelection().toString().length > 0) return; // Ê≠£Âú®È´ò‰∫ÆÂàô‰∏çÈÄâ
                        document.querySelectorAll('.draggable-item').forEach(el=>el.classList.remove('active-select'));
                        s4SelectedId = opt.id;
                        div.classList.add('active-select');
                    };
                    container.appendChild(div);
                }
            });
        }
        function allowDropS4(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function dropS4(ev) {
            ev.preventDefault(); ev.currentTarget.classList.remove('drag-over');
            const optId = ev.dataTransfer.getData("text");
            fillGapS4(ev.currentTarget.dataset.num, optId);
        }
        function handleClickGapS4(gapNum) {
            if (s4SelectedId) { fillGapS4(gapNum, s4SelectedId); s4SelectedId = null; } 
            else if (s4UserAnswers[gapNum]) { delete s4UserAnswers[gapNum]; updateStage4UI(); }
        }
        function fillGapS4(gapNum, optId) {
            for (let g in s4UserAnswers) { if (s4UserAnswers[g] === optId) delete s4UserAnswers[g]; }
            s4UserAnswers[gapNum] = optId;
            updateStage4UI();
        }
        function updateStage4UI() {
            renderStage4Pool();
            for (let i = 1; i <= 6; i++) {
                const gapEl = document.getElementById(`gap-${i}`);
                const ansId = s4UserAnswers[i];
                if (ansId) {
                    const optText = examData.options.find(o => o.id === ansId).text;
                    gapEl.classList.add('filled');
                    gapEl.innerHTML = `<strong>Paragraph ${ansId}</strong><p style="margin:5px 0; font-size:0.95rem; color:#333;">${optText}</p><small style="color:#c0392b">(Click to remove)</small>`;
                } else {
                    gapEl.classList.remove('filled');
                    gapEl.innerHTML = `[ GAP ${i} ] <br><small>(Drop Here or Click)</small>`;
                }
            }
        }
        function resetStage4() { s4UserAnswers = {}; updateStage4UI(); }
        function finishStage4() { clearInterval(timerInterval); showResultsStage4(); }

        // ================= ÁªìÊûúÁªìÁÆóÁ≥ªÁªü =================
        function showResultsStage1() {
            let score = 0; let html = '';
            examData.forEach((q, i) => {
                const correct = q.correct; const user = s1UserAnswers[i];
                const isCorrect = (user === correct); if (isCorrect) score++;
                let optsHtml = '';
                q.options.forEach((opt, idx) => {
                    let cls = 'review-opt';
                    if (idx === correct) cls += ' rev-correct';
                    else if (idx === user && !isCorrect) cls += ' rev-wrong';
                    else cls += ' rev-neutral';
                    optsHtml += `<div class="${cls}"><strong>${String.fromCharCode(65+idx)}.</strong> ${opt}</div>`;
                });
                html += renderReviewCard(`Question ${i+1}`, q.question, q.passage, optsHtml, isCorrect);
            });
            displayScoreboard(score, 8, html);
        }
        function showResultsStage2() {
            let score = 0; let html = '';
            examData.sections.forEach(sec => {
                const correct = sec.correct_heading; const user = s2UserAnswers[sec.id] || "None";
                const isCorrect = user === correct; if (isCorrect) score++;
                const content = `<div style="margin-top:10px;"><div class="${isCorrect?'tag-correct':'tag-wrong'}">Your Match: ${user}</div>${!isCorrect ? `<div class="tag-correct">Correct: ${correct}</div>` : ''}</div>`;
                html += renderReviewCard(`Section ${sec.id}`, sec.text.substring(0,80)+"...", "", content, isCorrect);
            });
            displayScoreboard(score, 7, html);
        }
        function showResultsStage3() {
            let score = 0; let html = '';
            examData.questions.forEach(q => {
                const user = s3UserAnswers[q.id] || "None";
                const isCorrect = user === q.correct_section; if (isCorrect) score++;
                const content = `<div style="margin-top:10px;"><div class="${isCorrect?'tag-correct':'tag-wrong'}">Your: Section ${user}</div>${!isCorrect ? `<div class="tag-correct">Correct: Section ${q.correct_section}</div>` : ''}</div>`;
                html += renderReviewCard(`Question ${q.id}`, q.text, "Locate Info", content, isCorrect);
            });
            displayScoreboard(score, 7, html);
        }
        function showResultsStage4() {
            let score = 0; let html = '';
            for(let i=1; i<=6; i++) {
                const user = s4UserAnswers[i];
                const correct = examData.answers[i];
                const isCorrect = user === correct; if(isCorrect) score++;
                const content = `<div style="margin-top:10px;">
                    <span class="${isCorrect?'tag-correct':'tag-wrong'}">Your Answer: ${user || 'Empty'}</span>
                    ${!isCorrect ? `<span class="tag-correct" style="margin-left:15px;">Correct: ${correct}</span>` : ''}
                </div>`;
                html += renderReviewCard(`Gap ${i}`, "Fill the gap", "", content, isCorrect);
            }
            displayScoreboard(score, 6, html);
        }
        function renderReviewCard(title, qText, passage, contentHtml, isCorrect) {
            return `<div class="review-card" style="border-left: 5px solid ${isCorrect ? 'var(--success)' : 'var(--error)'}">
                    <h3 style="margin-top:0; color:var(--primary);">${title}</h3>
                    ${passage ? `<div class="review-passage">${passage}</div>` : ''}
                    <p><strong>${qText}</strong></p>${contentHtml}</div>`;
        }
        function displayScoreboard(score, total, html) {
            document.querySelectorAll('.container').forEach(e => e.style.display = 'none');
            document.getElementById('scoreboard').style.display = 'block';
            document.getElementById('final-score').innerText = `${score} / ${total}`;
            document.getElementById('review-content').innerHTML = html;
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>